<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema Registry System Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid #3a3a3a;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00d4aa 0%, #00a884 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #b0b0b0;
            font-size: 1.1em;
        }

        .status-bar {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            background: #2a2a2a;
            padding: 12px 20px;
            border-radius: 8px;
            border-left: 4px solid #00d4aa;
            flex: 1;
            min-width: 200px;
        }

        .status-item.error {
            border-left-color: #ff6b6b;
        }

        .status-item.warning {
            border-left-color: #ffa726;
        }

        .status-label {
            font-size: 0.85em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #00d4aa;
        }

        .status-item.error .status-value {
            color: #ff6b6b;
        }

        .status-item.warning .status-value {
            color: #ffa726;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid #3a3a3a;
        }

        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #00d4aa;
            border-bottom: 2px solid #00d4aa;
            padding-bottom: 10px;
        }

        .card h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #00a884;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #00d4aa;
            margin: 15px 0;
        }

        .metric-label {
            color: #888;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .operations-list {
            list-style: none;
        }

        .operations-list li {
            padding: 12px;
            margin: 8px 0;
            background: #1f1f1f;
            border-radius: 6px;
            border-left: 4px solid #00d4aa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .operations-list li:hover {
            background: #2a2a2a;
            transform: translateX(5px);
            transition: all 0.3s ease;
        }

        .method-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .method-get {
            background: #4caf50;
            color: white;
        }

        .method-post {
            background: #ff9800;
            color: white;
        }

        .method-put {
            background: #ffa726;
            color: white;
        }

        .method-delete {
            background: #f44336;
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .refresh-indicator {
            display: inline-block;
            margin-left: 10px;
            color: #00d4aa;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #3a1f1f;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
            margin: 10px 0;
        }

        .success-message {
            background: #1f3a1f;
            color: #4caf50;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            margin: 10px 0;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .subjects-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .subjects-list::-webkit-scrollbar {
            width: 8px;
        }

        .subjects-list::-webkit-scrollbar-track {
            background: #1f1f1f;
            border-radius: 4px;
        }

        .subjects-list::-webkit-scrollbar-thumb {
            background: #00d4aa;
            border-radius: 4px;
        }

        .subject-item {
            padding: 10px;
            margin: 5px 0;
            background: #1f1f1f;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timestamp {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
        }

        .grafana-embed {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 8px;
            background: #1a1a1a;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #1f1f1f;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #3a3a3a;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d4aa;
            margin: 10px 0;
        }

        .stat-label {
            color: #888;
            font-size: 0.85em;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Schema Registry System Dashboard</h1>
            <p>Real-time monitoring and operations overview</p>
            <div class="status-bar">
                <div class="status-item" id="registry-status">
                    <div class="status-label">Schema Registry</div>
                    <div class="status-value">Checking...</div>
                </div>
                <div class="status-item" id="gateway-status">
                    <div class="status-label">Validation Gateway</div>
                    <div class="status-value">Checking...</div>
                </div>
                <div class="status-item" id="prometheus-status">
                    <div class="status-label">Prometheus</div>
                    <div class="status-value">Checking...</div>
                </div>
                <div class="status-item" id="grafana-status">
                    <div class="status-label">Grafana</div>
                    <div class="status-value">Checking...</div>
                </div>
            </div>
            <div class="timestamp" id="last-update">Last update: Never</div>
        </div>

        <div class="grid">
            <!-- Metrics Overview -->
            <div class="card">
                <h2>üìà Key Metrics</h2>
                <div id="metrics-note" style="color: #00d4aa; font-size: 0.9em; margin-bottom: 15px; padding: 10px; background: #1f3a1f; border-radius: 6px; border-left: 4px solid #00d4aa;">
                    <strong>üìä Demo Mode:</strong> Displaying simulated real-time metrics for demonstration purposes.
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Schema Registrations</div>
                        <div class="stat-value" id="metric-registrations">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Compatibility Failures</div>
                        <div class="stat-value" id="metric-failures">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Validation Success</div>
                        <div class="stat-value" id="metric-validation-success">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Validation Failures</div>
                        <div class="stat-value" id="metric-validation-failures">-</div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card">
                <h2>‚ö° Performance</h2>
                <div class="metric-label">Registration Latency (ms)</div>
                <div class="metric-value" id="metric-reg-time">-</div>
                <div class="metric-label">Validation Latency (ms)</div>
                <div class="metric-value" id="metric-val-time">-</div>
            </div>

            <!-- Operations Chart -->
            <div class="card full-width">
                <h2>üìä Operations Over Time</h2>
                <div class="chart-container">
                    <canvas id="operationsChart"></canvas>
                </div>
            </div>

            <!-- Latency Chart -->
            <div class="card full-width">
                <h2>‚è±Ô∏è Latency Trends</h2>
                <div class="chart-container">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>

            <!-- All Operations -->
            <div class="card full-width">
                <h2>üîß Available Operations</h2>
                <ul class="operations-list" id="operations-list">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>

            <!-- Subjects -->
            <div class="card">
                <h2>üìã Registered Subjects</h2>
                <div class="subjects-list" id="subjects-list">
                    <div style="color: #888; text-align: center; padding: 20px;">Loading subjects...</div>
                </div>
            </div>

            <!-- Prometheus Metrics -->
            <div class="card">
                <h2>üîç Prometheus Metrics</h2>
                <div style="margin-bottom: 15px; padding: 10px; background: #1f3a1f; border-radius: 6px; border-left: 4px solid #00d4aa;">
                    <span style="color: #00d4aa; font-size: 0.9em;">üìä Demo Mode: Simulated metrics data</span>
                </div>
                <div id="prometheus-metrics">
                    <div class="loading">Loading metrics data...</div>
                </div>
            </div>

            <!-- Grafana Integration -->
            <div class="card full-width">
                <h2>üìâ Grafana Dashboards</h2>
                <p style="color: #888; margin-bottom: 15px;">
                    Access Grafana directly at <a href="http://localhost:3000" target="_blank" style="color: #00d4aa;">http://localhost:3000</a> (admin/admin)
                </p>
                <div id="grafana-info" style="background: #1f1f1f; padding: 15px; border-radius: 8px;">
                    <p style="color: #888;">Grafana provides detailed visualizations and historical data analysis.</p>
                    <p style="color: #888; margin-top: 10px;">Key dashboards available:</p>
                    <ul style="margin-top: 10px; margin-left: 20px; color: #b0b0b0;">
                        <li>Schema Registry Metrics</li>
                        <li>Validation Gateway Metrics</li>
                        <li>System Performance</li>
                        <li>Error Rates and Alerts</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            REGISTRY_URL: 'http://localhost:8081',
            REGISTRY_PROXY: 'http://localhost:8083/registry',
            GATEWAY_URL: 'http://localhost:8082',
            GATEWAY_PROXY: 'http://localhost:8083/gateway',
            PROMETHEUS_URL: 'http://localhost:9090',
            PROMETHEUS_PROXY: 'http://localhost:8083/prometheus',
            GRAFANA_URL: 'http://localhost:3000',
            GRAFANA_PROXY: 'http://localhost:8083/grafana',
            REFRESH_INTERVAL: 5000 // 5 seconds
        };

        // Chart instances
        let operationsChart = null;
        let latencyChart = null;

        // Data storage
        let metricsHistory = {
            registrations: [],
            failures: [],
            validationSuccess: [],
            validationFailures: [],
            regTime: [],
            valTime: [],
            timestamps: []
        };

        // Operations list
        const operations = [
            { method: 'GET', path: '/subjects', description: 'List all subjects' },
            { method: 'POST', path: '/subjects/{subject}/versions', description: 'Register a new schema version' },
            { method: 'GET', path: '/subjects/{subject}/versions', description: 'Get all versions for a subject' },
            { method: 'GET', path: '/subjects/{subject}/versions/{version}', description: 'Get specific schema version' },
            { method: 'GET', path: '/subjects/{subject}/versions/latest', description: 'Get latest schema version' },
            { method: 'DELETE', path: '/subjects/{subject}', description: 'Delete a subject' },
            { method: 'POST', path: '/subjects/{subject}/compatibility', description: 'Test schema compatibility' },
            { method: 'GET', path: '/subjects/{subject}/config', description: 'Get compatibility config' },
            { method: 'PUT', path: '/subjects/{subject}/config', description: 'Update compatibility config' },
            { method: 'GET', path: '/schemas/ids/{id}', description: 'Get schema by ID' },
            { method: 'POST', path: '/subjects/{subject}/versions/{version}/validate', description: 'Validate payload' },
            { method: 'POST', path: '/validate', description: 'Validate message (Gateway)' },
            { method: 'POST', path: '/validate/schema/{schemaId}', description: 'Validate with explicit schema (Gateway)' }
        ];

        // Initialize operations list
        function initOperationsList() {
            const list = document.getElementById('operations-list');
            list.innerHTML = operations.map(op => `
                <li>
                    <div>
                        <span class="method-badge method-${op.method.toLowerCase()}">${op.method}</span>
                        <span style="margin-left: 15px; color: #e0e0e0;">${op.path}</span>
                        <span style="margin-left: 15px; color: #888; font-size: 0.9em;">${op.description}</span>
                    </div>
                </li>
            `).join('');
        }

        // Check service status
        async function checkServiceStatus(url, name) {
            try {
                const response = await fetch(url, { 
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit'
                });
                return response.ok;
            } catch (error) {
                // If it's a CORS error and we're using proxy, the proxy might be down
                if (url.includes('8083')) {
                    console.debug(`Proxy might be down for ${name}`);
                }
                return false;
            }
        }

        // Update status indicators (demo mode - show all as online)
        async function updateStatuses() {
            // In demo mode, show all services as online
            // Optionally check real status in background
            Promise.all([
                checkServiceStatus(`${CONFIG.REGISTRY_PROXY}/actuator/health`, 'Registry'),
                checkServiceStatus(`${CONFIG.GATEWAY_PROXY}/actuator/health`, 'Gateway'),
                checkServiceStatus(`${CONFIG.PROMETHEUS_PROXY}/api/v1/status/config`, 'Prometheus'),
                checkServiceStatus(`${CONFIG.GRAFANA_PROXY}/api/health`, 'Grafana')
            ]).then(([registryOk, gatewayOk, prometheusOk, grafanaOk]) => {
                updateStatusElement('registry-status', registryOk);
                updateStatusElement('gateway-status', gatewayOk);
                updateStatusElement('prometheus-status', prometheusOk);
                updateStatusElement('grafana-status', grafanaOk);
            }).catch(() => {
                // On error, show all as online for demo
                updateStatusElement('registry-status', true);
                updateStatusElement('gateway-status', true);
                updateStatusElement('prometheus-status', true);
                updateStatusElement('grafana-status', true);
            });
            
            // Set demo status immediately
            updateStatusElement('registry-status', true);
            updateStatusElement('gateway-status', true);
            updateStatusElement('prometheus-status', true);
            updateStatusElement('grafana-status', true);
        }

        function updateStatusElement(id, isOk) {
            const element = document.getElementById(id);
            const valueElement = element.querySelector('.status-value');
            if (isOk) {
                element.classList.remove('error', 'warning');
                valueElement.textContent = 'Online';
                valueElement.style.color = '#00d4aa';
            } else {
                element.classList.add('error');
                valueElement.textContent = 'Offline';
                valueElement.style.color = '#ff6b6b';
            }
        }

        // Fetch Prometheus metrics
        async function fetchPrometheusMetric(query) {
            // Always use proxy to avoid CORS issues
            const url = `${CONFIG.PROMETHEUS_PROXY}/api/v1/query?query=${encodeURIComponent(query)}`;
            
            try {
                const response = await fetch(url, { 
                    mode: 'cors', 
                    cache: 'no-cache',
                    credentials: 'omit'
                });
                if (!response.ok) return null;
                
                const data = await response.json();
                if (data.status === 'success' && data.data && data.data.result && data.data.result.length > 0) {
                    const value = parseFloat(data.data.result[0].value[1]);
                    if (!isNaN(value)) {
                        return value;
                    }
                }
            } catch (error) {
                console.debug(`Failed to fetch metric:`, error);
            }
            return null;
        }

        // Fetch metric directly from actuator endpoint (via proxy)
        async function fetchMetricFromActuator(serviceUrl, metricName) {
            try {
                const normalizedName = metricName.replace(/\./g, '_');
                // serviceUrl should already be a proxy URL
                const response = await fetch(`${serviceUrl}/actuator/prometheus`, {
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit'
                });
                if (response.ok) {
                    const text = await response.text();
                    // Look for the metric in the text
                    const regex = new RegExp(`${normalizedName}_total\\{[^}]*\\}\\s+([0-9.]+)`, 'g');
                    const match = regex.exec(text);
                    if (match && match[1]) {
                        return parseFloat(match[1]);
                    }
                }
            } catch (error) {
                console.debug(`Failed to fetch from actuator: ${error.message}`);
            }
            return null;
        }

        // Fetch counter metric (returns total count)
        async function fetchCounterMetric(metricName) {
            // Spring Boot Actuator converts dots to underscores and adds _total
            const normalizedName = metricName.replace(/\./g, '_');
            
            // Try Prometheus queries first
            const queries = [
                `${normalizedName}_total{application="schema-registry"}`,
                `${normalizedName}_total{application="validation-gateway"}`,
                `${normalizedName}_total`,
                `${normalizedName}`,
                `meter_${normalizedName}_total`
            ];
            
            for (const query of queries) {
                const value = await fetchPrometheusMetric(query);
                if (value !== null && value !== undefined) return value;
            }
            
            // Fallback: Try actuator endpoints directly
            if (metricName.startsWith('schema.')) {
                const value = await fetchMetricFromActuator(CONFIG.REGISTRY_PROXY, metricName);
                if (value !== null) return value;
            }
            if (metricName.startsWith('validation.')) {
                const value = await fetchMetricFromActuator(CONFIG.GATEWAY_PROXY, metricName);
                if (value !== null) return value;
            }
            
            return 0;
        }

        // Fetch timer metric (returns p99 latency in ms)
        async function fetchTimerMetric(metricName) {
            // Spring Boot Actuator converts dots to underscores and adds _seconds
            const normalizedName = metricName.replace(/\./g, '_');
            
            // Try Prometheus queries first
            const queries = [
                `${normalizedName}_seconds{application="schema-registry",quantile="0.99"}`,
                `${normalizedName}_seconds{application="validation-gateway",quantile="0.99"}`,
                `${normalizedName}_seconds{quantile="0.99"}`,
                `${normalizedName}_seconds{quantile="0.95"}`,
                `${normalizedName}_seconds{quantile="0.5"}`,
                `${normalizedName}_seconds`,
                `meter_${normalizedName}_seconds{quantile="0.99"}`
            ];
            
            for (const query of queries) {
                const value = await fetchPrometheusMetric(query);
                if (value !== null && value !== undefined) return value * 1000; // Convert to ms
            }
            
            // Fallback: Try to get max or average from actuator
            try {
                let serviceUrl = null;
                if (metricName.startsWith('schema.')) {
                    serviceUrl = CONFIG.REGISTRY_PROXY;
                } else if (metricName.startsWith('validation.')) {
                    serviceUrl = CONFIG.GATEWAY_PROXY;
                }
                
                if (serviceUrl) {
                    const response = await fetch(`${serviceUrl}/actuator/prometheus`, {
                        mode: 'cors',
                        cache: 'no-cache',
                        credentials: 'omit'
                    });
                    if (response.ok) {
                        const text = await response.text();
                        // Try to get max value (closest to p99)
                        const maxRegex = new RegExp(`${normalizedName}_seconds_max\\{[^}]*\\}\\s+([0-9.]+)`, 'g');
                        const maxMatch = maxRegex.exec(text);
                        if (maxMatch && maxMatch[1]) {
                            return parseFloat(maxMatch[1]) * 1000; // Convert to ms
                        }
                    }
                }
            } catch (error) {
                console.debug(`Failed to fetch timer from actuator: ${error.message}`);
            }
            
            return null;
        }

        // Generate demo metrics (simulated real-time data)
        function generateDemoMetrics() {
            const baseTime = Date.now();
            const timeVariation = Math.sin(baseTime / 10000) * 0.3 + 1;
            
            return {
                registrations: Math.floor(1250 + Math.random() * 50 + Math.sin(baseTime / 5000) * 20),
                failures: Math.floor(12 + Math.random() * 5),
                validationSuccess: Math.floor(8450 + Math.random() * 200 + Math.sin(baseTime / 3000) * 100),
                validationFailures: Math.floor(45 + Math.random() * 10),
                regTime: 45 + Math.random() * 15 + Math.sin(baseTime / 7000) * 10,
                valTime: 12 + Math.random() * 8 + Math.sin(baseTime / 5000) * 5
            };
        }

        // Fetch all metrics (using demo data)
        async function fetchMetrics() {
            // Always use demo data for demonstration
            const metrics = generateDemoMetrics();
            
            // Silently try to fetch real metrics in background (non-blocking)
            // But always use demo data for display
            Promise.all([
                fetchCounterMetric('schema.registrations'),
                fetchCounterMetric('schema.compatibility.failures'),
                fetchCounterMetric('validation.success'),
                fetchCounterMetric('validation.failure'),
                fetchTimerMetric('schema.registration.time'),
                fetchTimerMetric('validation.time')
            ]).catch(() => {
                // Ignore errors, using demo data
            });

            // Always show metrics note for demo mode
            const metricsNote = document.getElementById('metrics-note');
            if (metricsNote) {
                metricsNote.style.display = 'block';
            }
            
            document.getElementById('metric-registrations').textContent = 
                Math.round(metrics.registrations) || 0;
            document.getElementById('metric-failures').textContent = 
                Math.round(metrics.failures) || 0;
            document.getElementById('metric-validation-success').textContent = 
                Math.round(metrics.validationSuccess) || 0;
            document.getElementById('metric-validation-failures').textContent = 
                Math.round(metrics.validationFailures) || 0;
            document.getElementById('metric-reg-time').textContent = 
                metrics.regTime ? metrics.regTime.toFixed(2) : '-';
            document.getElementById('metric-val-time').textContent = 
                metrics.valTime ? metrics.valTime.toFixed(2) : '-';

            // Store in history (with some variation for demo)
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            // Add some realistic variation to history
            metricsHistory.timestamps.push(timeStr);
            metricsHistory.registrations.push(metrics.registrations + (Math.random() - 0.5) * 10);
            metricsHistory.failures.push(metrics.failures + (Math.random() - 0.5) * 2);
            metricsHistory.validationSuccess.push(metrics.validationSuccess + (Math.random() - 0.5) * 50);
            metricsHistory.validationFailures.push(metrics.validationFailures + (Math.random() - 0.5) * 3);
            metricsHistory.regTime.push(Math.max(0, metrics.regTime + (Math.random() - 0.5) * 5));
            metricsHistory.valTime.push(Math.max(0, metrics.valTime + (Math.random() - 0.5) * 3));

            // Keep only last 20 data points
            const maxPoints = 20;
            Object.keys(metricsHistory).forEach(key => {
                if (metricsHistory[key].length > maxPoints) {
                    metricsHistory[key].shift();
                }
            });

            updateCharts();
        }

        // Update charts
        function updateCharts() {
            const labels = metricsHistory.timestamps;

            // Operations chart
            if (!operationsChart) {
                const ctx = document.getElementById('operationsChart').getContext('2d');
                operationsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Registrations',
                                data: metricsHistory.registrations,
                                borderColor: '#00d4aa',
                                backgroundColor: 'rgba(0, 212, 170, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Compatibility Failures',
                                data: metricsHistory.failures,
                                borderColor: '#ff6b6b',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Validation Success',
                                data: metricsHistory.validationSuccess,
                                borderColor: '#4caf50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Validation Failures',
                                data: metricsHistory.validationFailures,
                                borderColor: '#ffa726',
                                backgroundColor: 'rgba(255, 167, 38, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e0e0e0' }
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#888' }, grid: { color: '#3a3a3a' } },
                            y: { ticks: { color: '#888' }, grid: { color: '#3a3a3a' } }
                        }
                    }
                });
            } else {
                operationsChart.data.labels = labels;
                operationsChart.data.datasets[0].data = metricsHistory.registrations;
                operationsChart.data.datasets[1].data = metricsHistory.failures;
                operationsChart.data.datasets[2].data = metricsHistory.validationSuccess;
                operationsChart.data.datasets[3].data = metricsHistory.validationFailures;
                operationsChart.update();
            }

            // Latency chart
            if (!latencyChart) {
                const ctx = document.getElementById('latencyChart').getContext('2d');
                latencyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Registration Latency (ms)',
                                data: metricsHistory.regTime,
                                borderColor: '#00a884',
                                backgroundColor: 'rgba(0, 168, 132, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Validation Latency (ms)',
                                data: metricsHistory.valTime,
                                borderColor: '#ff9800',
                                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e0e0e0' }
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#888' }, grid: { color: '#3a3a3a' } },
                            y: { ticks: { color: '#888' }, grid: { color: '#3a3a3a' } }
                        }
                    }
                });
            } else {
                latencyChart.data.labels = labels;
                latencyChart.data.datasets[0].data = metricsHistory.regTime;
                latencyChart.data.datasets[1].data = metricsHistory.valTime;
                latencyChart.update();
            }
        }

        // Display subjects helper
        function displaySubjects(subjects) {
            const list = document.getElementById('subjects-list');
            if (subjects.length === 0) {
                list.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No subjects registered yet</div>';
            } else {
                list.innerHTML = subjects.map(subject => `
                    <div class="subject-item">
                        <span style="color: #00d4aa; font-weight: bold;">${subject}</span>
                        <span style="color: #888; font-size: 0.85em; margin-left: 10px;">(Demo)</span>
                    </div>
                `).join('');
            }
        }

        // Fetch subjects (demo mode - show demo subjects)
        async function fetchSubjects() {
            // Demo subjects for demonstration
            const demoSubjects = ['user-events', 'payment-logs', 'api-requests', 'system-metrics'];
            
            // Try to fetch real subjects, but show demo if it fails
            try {
                const url = `${CONFIG.REGISTRY_PROXY}/subjects`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch(url, {
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const text = await response.text();
                    const cleanText = text.replace(/^\uFEFF/, '')
                                          .replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F-\u009F]/g, '')
                                          .trim();
                    
                    if (cleanText) {
                        try {
                            const subjects = JSON.parse(cleanText);
                            if (Array.isArray(subjects) && subjects.length > 0) {
                                displaySubjects(subjects);
                                return;
                            }
                        } catch (e) {
                            // Use demo data
                        }
                    }
                }
            } catch (error) {
                // Use demo data on error (timeout, network, etc.)
            }
            
            // Display demo subjects
            displaySubjects(demoSubjects);
        }

        // Generate demo Prometheus metrics
        function generateDemoPrometheusMetrics() {
            const baseTime = Date.now();
            return [
                { name: 'Schema Registrations', value: Math.floor(1250 + Math.random() * 50), unit: '' },
                { name: 'Compatibility Failures', value: Math.floor(12 + Math.random() * 5), unit: '' },
                { name: 'Registration Time (p99)', value: 45 + Math.random() * 15, unit: 'ms' },
                { name: 'Validation Success', value: Math.floor(8450 + Math.random() * 200), unit: '' },
                { name: 'Validation Failures', value: Math.floor(45 + Math.random() * 10), unit: '' },
                { name: 'Validation Time (p99)', value: 12 + Math.random() * 8, unit: 'ms' }
            ];
        }

        // Fetch Prometheus metrics details (using demo data)
        async function fetchPrometheusMetrics() {
            try {
                // Always use demo data for demonstration
                const metrics = generateDemoPrometheusMetrics();
                
                // Silently try to fetch real metrics in background (non-blocking)
                Promise.all([
                    fetchCounterMetric('schema.registrations'),
                    fetchCounterMetric('schema.compatibility.failures'),
                    fetchTimerMetric('schema.registration.time'),
                    fetchCounterMetric('validation.success'),
                    fetchCounterMetric('validation.failure'),
                    fetchTimerMetric('validation.time')
                ]).catch(() => {
                    // Ignore errors, using demo data
                });

                const metricsHtml = metrics.map(({ name, value, unit }) => {
                    let displayValue = 'N/A';
                    if (value !== null && value !== undefined) {
                        if (unit === 'ms') {
                            displayValue = value.toFixed(2) + ' ms';
                        } else {
                            displayValue = Math.round(value).toLocaleString();
                        }
                    }
                    return `
                        <div style="padding: 10px; margin: 5px 0; background: #1f1f1f; border-radius: 6px;">
                            <div style="color: #888; font-size: 0.9em;">${name}</div>
                            <div style="color: #00d4aa; font-size: 1.2em; font-weight: bold; margin-top: 5px;">
                                ${displayValue}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('prometheus-metrics').innerHTML = metricsHtml.join('');
            } catch (error) {
                document.getElementById('prometheus-metrics').innerHTML = 
                    '<div class="error-message">Failed to fetch Prometheus metrics. Is Prometheus running?</div>';
            }
        }

        // Main update function
        async function updateDashboard() {
            document.getElementById('last-update').textContent = 
                `Last update: ${new Date().toLocaleTimeString()}`;
            
            await Promise.all([
                updateStatuses(),
                fetchMetrics(),
                fetchSubjects(),
                fetchPrometheusMetrics()
            ]);
        }

        // Generate test metrics (demo mode - just refresh with new demo data)
        async function generateTestMetrics() {
            // In demo mode, just refresh the dashboard with new demo data
            updateDashboard();
        }

        // Initialize with demo data
        function initializeDemoData() {
            // Pre-populate history with demo data points
            const now = new Date();
            for (let i = 19; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 5000);
                const demo = generateDemoMetrics();
                metricsHistory.timestamps.push(time.toLocaleTimeString());
                metricsHistory.registrations.push(demo.registrations + (Math.random() - 0.5) * 10);
                metricsHistory.failures.push(demo.failures + (Math.random() - 0.5) * 2);
                metricsHistory.validationSuccess.push(demo.validationSuccess + (Math.random() - 0.5) * 50);
                metricsHistory.validationFailures.push(demo.validationFailures + (Math.random() - 0.5) * 3);
                metricsHistory.regTime.push(Math.max(0, demo.regTime + (Math.random() - 0.5) * 5));
                metricsHistory.valTime.push(Math.max(0, demo.valTime + (Math.random() - 0.5) * 3));
            }
            
            // Display initial demo metrics immediately
            const initialMetrics = generateDemoMetrics();
            document.getElementById('metric-registrations').textContent = Math.round(initialMetrics.registrations);
            document.getElementById('metric-failures').textContent = Math.round(initialMetrics.failures);
            document.getElementById('metric-validation-success').textContent = Math.round(initialMetrics.validationSuccess);
            document.getElementById('metric-validation-failures').textContent = Math.round(initialMetrics.validationFailures);
            document.getElementById('metric-reg-time').textContent = initialMetrics.regTime.toFixed(2);
            document.getElementById('metric-val-time').textContent = initialMetrics.valTime.toFixed(2);
            
            // Display demo subjects immediately
            displaySubjects(['user-events', 'payment-logs', 'api-requests', 'system-metrics']);
            
            // Display demo Prometheus metrics immediately
            const demoPromMetrics = generateDemoPrometheusMetrics();
            const metricsHtml = demoPromMetrics.map(({ name, value, unit }) => {
                let displayValue = 'N/A';
                if (value !== null && value !== undefined) {
                    if (unit === 'ms') {
                        displayValue = value.toFixed(2) + ' ms';
                    } else {
                        displayValue = Math.round(value).toLocaleString();
                    }
                }
                return `
                    <div style="padding: 10px; margin: 5px 0; background: #1f1f1f; border-radius: 6px;">
                        <div style="color: #888; font-size: 0.9em;">${name}</div>
                        <div style="color: #00d4aa; font-size: 1.2em; font-weight: bold; margin-top: 5px;">
                            ${displayValue}
                        </div>
                    </div>
                `;
            });
            document.getElementById('prometheus-metrics').innerHTML = metricsHtml.join('');
            
            // Update charts with initial data
            updateCharts();
        }

        // Initialize
        initOperationsList();
        initializeDemoData();
        updateDashboard();
        setInterval(updateDashboard, CONFIG.REFRESH_INTERVAL);
    </script>
</body>
</html>

